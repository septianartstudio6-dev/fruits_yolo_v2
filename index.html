<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Fruit Detection TFJS</title>

<!-- TensorFlow -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.19.0/dist/tf.min.js"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f2f2f2;
        margin: 0;
        padding: 20px;
        text-align: center;
    }

    #video {
        width: 640px;
        height: 480px;
        border-radius: 10px;
        background: #000;
    }

    #canvas {
        position: absolute;
        top: 0;
        left: 0;
    }

    #container {
        display: inline-block;
        position: relative;
    }

    h2 {
        margin-bottom: 10px;
    }

    button, select {
        padding: 10px 20px;
        margin: 10px;
        border: none;
        background: #007bff;
        color: white;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
    }

    button:hover, select:hover {
        background: #0056b3;
    }

    #thresholdBox {
        margin-top: 10px;
        font-size: 18px;
    }

    input[type="range"] {
        width: 200px;
    }
</style>
</head>
<body>

<h2>Fruit Detector - TensorFlow.js</h2>

<!-- Camera options -->
<select id="cameraSelect">
    <option value="environment">ðŸ“· Back Camera</option>
    <option value="user">ðŸ¤³ Front Camera</option>
</select>

<button onclick="startCamera()">Start Camera</button>

<div id="thresholdBox">
    Threshold: <span id="thVal">50</span>%  
    <br>
    <input type="range" id="threshold" min="10" max="100" value="50" oninput="updateThreshold()">
</div>

<div id="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>
</div>

<script>
/* ===========================
   1. Load Model and Class Names
   =========================== */

const modelUrl = "https://vkduvjyfrrjlckkk.public.blob.vercel-storage.com/model.json";

let model;
let threshold = 0.5;

// Class names from your metadata.yaml
const classNames = [
    "Alpukat","Anggur","Apel","Apel Hijau","Jeruk","Lemon","Mangga",
    "Melon","Nanas","Pepaya","Pir","Pisang","Rambutan","Salak",
    "Semangka","Stroberi"
];

function updateThreshold() {
    const val = document.getElementById("threshold").value;
    threshold = val / 100;
    document.getElementById("thVal").innerText = val;
}

/* ===========================
   2. Start Camera (front/back)
   =========================== */
async function startCamera() {
    const video = document.getElementById("video");
    const cameraMode = document.getElementById("cameraSelect").value;

    const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: cameraMode }
    });

    video.srcObject = stream;

    video.onloadedmetadata = () => {
        video.play();
        runDetection();
    };

    if (!model) {
        model = await tf.loadGraphModel(modelUrl);
        console.log("Model Loaded");
    }
}


/* ===========================
   3. Detection Loop
   =========================== */
async function runDetection() {
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    const detectFrame = async () => {
        if (!model) return requestAnimationFrame(detectFrame);

        const input = tf.tidy(() => {
            return tf.browser.fromPixels(video)
                .resizeBilinear([640, 640])
                .expandDims(0)
                .div(255.0);
        });

        let predictions = await model.executeAsync(input);

        const boxes = predictions[0].arraySync()[0];
        const scores = predictions[1].arraySync()[0];
        const labels = predictions[2].arraySync()[0];

        tf.dispose(predictions);
        tf.dispose(input);

        // Draw video frame
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // Draw detection
        for (let i = 0; i < scores.length; i++) {
            if (scores[i] < threshold) continue; 

            const [ymin, xmin, ymax, xmax] = boxes[i];

            const x = xmin * canvas.width;
            const y = ymin * canvas.height;
            const width = (xmax - xmin) * canvas.width;
            const height = (ymax - ymin) * canvas.height;

            const className = classNames[labels[i]];

            ctx.strokeStyle = "red";
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, width, height);

            ctx.fillStyle = "red";
            ctx.font = "18px Arial";
            ctx.fillText(className + " (" + (scores[i] * 100).toFixed(1) + "%)", x + 5, y + 20);
        }

        requestAnimationFrame(detectFrame);
    };

    detectFrame();
}
</script>

</body>
</html>
